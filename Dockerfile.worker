# ───────────────────────────────────────────────────────
# Dockerfile.worker — Viber daemon / worker runtime
# ───────────────────────────────────────────────────────
FROM node:22-alpine AS base

# Enable corepack for pnpm
RUN corepack enable && corepack prepare pnpm@10.28.2 --activate

WORKDIR /app

# ── Install dependencies ──────────────────────────────
FROM base AS deps
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod=false

# ── Build CLI + worker ────────────────────────────────
FROM deps AS build
COPY tsup.config.ts tsconfig.json ./
COPY src/ src/
RUN pnpm build

# ── Production image ──────────────────────────────────
FROM node:22-alpine AS production
WORKDIR /app

COPY --from=build /app/dist dist
COPY --from=build /app/node_modules node_modules
COPY --from=build /app/package.json .

ENV NODE_ENV=production

# GATEWAY_WS_URL must be set in Railway environment variables
# e.g. wss://gateway.railway.internal/ws  (private networking)
# or   wss://your-gateway.up.railway.app/ws (public)
CMD ["sh", "-c", "node dist/cli/index.js start --server ${GATEWAY_WS_URL}"]
